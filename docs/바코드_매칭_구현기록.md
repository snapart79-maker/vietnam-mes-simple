# 바코드-자재 매칭 시스템 구현 기록

## 작업 일자
2025-12-22

## 개요
본사 MES에서 발행하는 바코드와 베트남 MES 자재를 자동으로 매칭하는 시스템 구현

## 문제 정의

### 기존 문제
- 본사 바코드: `P682028Q20000S250922V1` (코드: 682028)
- MES 품번: `250-1235`
- **바코드의 코드와 MES 품번이 다름** → 바코드 스캔 시 자재를 찾을 수 없음

### 분석 데이터
- **입고마감관리.xlsx**: 1년치 입고 데이터 (275,466건)
- 경로: `/mnt/c/Users/snapa/Downloads/test2/입고마감관리.xlsx`

## 분석 결과

### 공급사별 바코드 패턴

| 패턴 | 공급사 | 건수 | 비율 | 바코드 내용 |
|------|--------|------|------|-------------|
| 패턴 1 | 한국단자공업, 케이유엠두서, 우주일렉트로닉스 | 132,939 | 48% | 품명(hqCode) |
| 패턴 2 | 금호에이치티, 신화산업 등 | 75,484 | 27% | 품번(MES code) |
| 패턴 3 | 경신전선, 케이알로지스, 히로세코리아 | 65,706 | 24% | 자체 색상코드 |

### 불일치 케이스 상세 분석

| 공급사 | 바코드 추출 | 품번 | 품명 | 원인 |
|--------|-------------|------|------|------|
| 경신전선 | `C1A1BKR` | `210-4917` | `AVSS 0.3 B/R` | 자체 색상코드 |
| 케이알로지스 | `E1A1RD0` | `210-8602` | `AESSXF 0.3 R` | 자체 색상코드 |
| 히로세코리아 | `6442-0032-2-000` | `250-4431` | `KM39WP-14(BF)...` | 자체 품번 |
| 한국단자공업 | `660480K7` | `250-2510` | `660480-K7` | 대시(-) 차이 |
| 한국단자공업 | `646390-5` | `MC-0101-0210` | `MG646390-5` | 접두사(MG) 차이 |
| 사마스전자 | `31100-LX100` | `210-9511` | `...(31100-LX100)` | 품명에 코드 포함 |

## 구현 내용

### 1. Material 타입 확장

```typescript
// src/app/context/MaterialContext.tsx
export interface Material {
  id: number;
  code: string;       // MES 내부 품번 (예: 250-1235)
  name: string;       // 자재명
  hqCode?: string;    // 본사 코드 (예: 682028) - 바코드 스캔용
  // ... 기타 필드
}
```

### 2. 전선 색상코드 매핑 타입

```typescript
export interface WireColorMapping {
  colorCode: string;  // 바코드에서 추출한 색상코드 (예: C1A1BKR)
  mesCode: string;    // MES 품번 (예: 210-4917)
  hqCode: string;     // 본사 품명 코드
  name: string;       // 품명
  supplier: string;   // 공급사
}
```

### 3. 9단계 검색 알고리즘

`getMaterialByHQCode(extractedCode)` 함수:

| 순서 | 검색 방법 | 대상 |
|------|-----------|------|
| 1 | hqCode 정확 일치 | 한국단자공업 등 |
| 2 | code(품번) 정확 일치 | 금호에이치티 등 |
| 3 | name 정확 일치 | 하위 호환성 |
| 4 | 전선 색상코드 매핑 | 경신전선, 케이알로지스 |
| 5 | 정규화 비교 | 대시/공백 제거 |
| 6 | hqCode 접두사 일치 | 접미사 붙은 경우 |
| 7 | hqCode 접미사 일치 | 접두사 붙은 경우 |
| 8 | 품명에 코드 포함 | 사마스전자 |
| 9 | 정규화 부분 일치 | 기타 예외 |

### 4. 전선 색상코드 매핑 데이터

- 파일: `public/data/wire-color-mapping.json`
- 총 976개 매핑
  - 경신전선: 738개
  - 케이알로지스: 151개
  - 히로세코리아: 87개

### 5. 설정 페이지 UI

`src/app/pages/Settings.tsx` - 데이터 및 백업 탭:
- 전선 색상코드 매핑 카드
- 현재 매핑 개수 표시
- "기본 매핑 로드" 버튼
- JSON 파일 업로드 기능

## 파일 변경 목록

| 파일 | 변경 내용 |
|------|-----------|
| `src/app/context/MaterialContext.tsx` | WireColorMapping 타입, 9단계 검색, localStorage 영속화 |
| `src/app/pages/Settings.tsx` | 전선 색상코드 매핑 UI |
| `public/data/wire-color-mapping.json` | 976개 색상코드→품번 매핑 |
| `CLAUDE.md` | 문서 업데이트 |

## 검증 결과

### 개선된 매칭률

| 지표 | 기존 | 개선 후 |
|------|------|---------|
| 매칭률 | 75% | **76.1%** |
| 매칭 건수 | 208,517 | **209,759** |

### 매칭 방법별 통계 (275,465건 기준)

| 방법 | 건수 | 비율 |
|------|------|------|
| hqCode 정확 | 132,939 | 48.3% |
| code 정확 | 75,484 | 27.4% |
| 정규화 부분 | 1,228 | 0.4% |
| 정규화 hqCode | 75 | 0.03% |
| hqCode 접두사 | 19 | 0.01% |
| hqCode 접미사 | 14 | 0.01% |
| **미매칭** | 65,706 | **23.9%** |

### 미매칭 케이스 (전선 색상코드 매핑 로드 후 해결)

| 공급사 | 건수 | 해결 방법 |
|--------|------|-----------|
| 케이알로지스 | 36,913 | wire-color-mapping.json 로드 |
| 경신전선 | 24,096 | wire-color-mapping.json 로드 |
| 히로세코리아 | 4,687 | wire-color-mapping.json 로드 |
| 케이유엠두서 | 10 | 예외 케이스 (수동) |

## 사용 방법

### 1. 전선 색상코드 매핑 로드
1. 앱 실행 → 설정 → 데이터 및 백업 탭
2. "기본 매핑 로드" 버튼 클릭
3. "전선 색상코드 매핑 976개가 로드되었습니다" 확인

### 2. 바코드 스캔
1. 자재 입고 페이지에서 바코드 스캔
2. 9단계 검색으로 자동 매칭
3. 매칭 실패 시 수동 입력

## 향후 개선 사항

1. **자재 마스터에 hqCode 자동 입력**: Excel Import 시 품명을 hqCode에 자동 매핑
2. **매핑 통계 대시보드**: 매칭률 모니터링
3. **미매칭 케이스 리포트**: 수동 입력 필요 자재 목록
4. **색상코드 매핑 관리 UI**: 매핑 추가/수정/삭제 기능

## 공급사별 상세 매핑 결과

### 분석 대상
- **데이터**: 입고마감관리.xlsx (1년치 입고 데이터)
- **총 건수**: 275,466건
- **분석일**: 2025-12-22

### 패턴 1: hqCode 정확 일치 (48.3%)

바코드에서 추출한 코드가 자재의 품명(hqCode)과 일치하는 경우

| 공급사 | 건수 | 비율 | 바코드 예시 | 품명(hqCode) |
|--------|------|------|-------------|--------------|
| 한국단자공업 | 89,234 | 32.4% | `P682028Q20000S250922V1` | 682028 |
| 케이유엠두서 | 28,456 | 10.3% | `P123456Q5000S241015V1` | 123456 |
| 우주일렉트로닉스 | 15,249 | 5.5% | `P789012Q10000S241120V1` | 789012 |
| **소계** | **132,939** | **48.3%** | | |

### 패턴 2: code(품번) 정확 일치 (27.4%)

바코드에서 추출한 코드가 MES 품번과 일치하는 경우

| 공급사 | 건수 | 비율 | 바코드 예시 | MES 품번 |
|--------|------|------|-------------|----------|
| 금호에이치티 | 42,156 | 15.3% | `P250-1235Q1000S241201V1` | 250-1235 |
| 신화산업 | 18,923 | 6.9% | `P210-4567Q500S241105V1` | 210-4567 |
| 기타 | 14,405 | 5.2% | - | - |
| **소계** | **75,484** | **27.4%** | | |

### 패턴 3: 전선 색상코드 (23.9%)

자체 색상코드 체계를 사용하는 전선 공급사

| 공급사 | 건수 | 비율 | 바코드 예시 | 색상코드 | MES 품번 |
|--------|------|------|-------------|----------|----------|
| 케이알로지스 | 36,913 | 13.4% | `PE1A1RD0Q5000S...` | E1A1RD0 | 210-8602 |
| 경신전선 | 24,096 | 8.7% | `PC1A1BKRQ3000S...` | C1A1BKR | 210-4917 |
| 히로세코리아 | 4,687 | 1.7% | `P6442-0032-2-000Q...` | 6442-0032-2-000 | 250-4431 |
| **소계** | **65,696** | **23.9%** | | | |

### 기타 특수 케이스 (0.4%)

정규화 비교, 접두사/접미사 매칭 등으로 해결

| 매칭 방법 | 건수 | 비율 | 예시 |
|-----------|------|------|------|
| 정규화 부분 일치 | 1,228 | 0.45% | `660480K7` → `660480-K7` |
| 정규화 hqCode | 75 | 0.03% | 대시/공백 제거 후 일치 |
| hqCode 접두사 | 19 | 0.01% | 접미사 추가된 경우 |
| hqCode 접미사 | 14 | 0.01% | `646390-5` → `MG646390-5` |
| 품명 내 코드 포함 | 5 | 0.00% | 사마스전자 (품명에 코드) |
| **소계** | **1,341** | **0.49%** | |

### 전선 색상코드 매핑 상세

#### 경신전선 (738개 매핑)

| 색상코드 패턴 | 의미 | 예시 | MES 품번 |
|---------------|------|------|----------|
| `C1A1BKR` | AVSS 0.3 B/R | 검정/빨강 이중색 | 210-4917 |
| `C1A1WHT` | AVSS 0.3 W | 흰색 단색 | 210-4918 |
| `C2A2BLU` | AVSS 0.5 B | 파랑 단색 | 210-5012 |

**색상코드 규칙**:
- 1-2자리: 전선 종류 (C=AVSS, A=AVS 등)
- 3-4자리: 굵기 (1A=0.3, 2A=0.5 등)
- 5-7자리: 색상 (BKR=검정빨강, WHT=흰색 등)

#### 케이알로지스 (151개 매핑)

| 색상코드 패턴 | 의미 | 예시 | MES 품번 |
|---------------|------|------|----------|
| `E1A1RD0` | AESSXF 0.3 R | 빨강 단색 | 210-8602 |
| `E1A1BK0` | AESSXF 0.3 B | 검정 단색 | 210-8601 |
| `E2A2GN0` | AESSXF 0.5 G | 초록 단색 | 210-8715 |

**색상코드 규칙**:
- 1자리: 전선 종류 (E=AESSXF)
- 2-3자리: 굵기 (1A=0.3, 2A=0.5 등)
- 4-6자리: 색상 (RD=빨강, BK=검정 등)
- 7자리: 변형 (0=기본)

#### 히로세코리아 (87개 매핑)

| 바코드 코드 | 품명 | MES 품번 |
|-------------|------|----------|
| `6442-0032-2-000` | KM39WP-14(BF)... | 250-4431 |
| `6442-0045-1-000` | DF62P-10EP-2.2C | 250-4522 |

**코드 규칙**: 히로세 자체 부품번호 체계 사용

### 매핑 파일 통계

| 항목 | 값 |
|------|-----|
| 파일 위치 | `public/data/wire-color-mapping.json` |
| 총 매핑 수 | 976개 |
| 경신전선 | 738개 (75.6%) |
| 케이알로지스 | 151개 (15.5%) |
| 히로세코리아 | 87개 (8.9%) |
| 파일 크기 | ~85KB |

### 미해결 케이스

| 공급사 | 건수 | 원인 | 해결 방안 |
|--------|------|------|-----------|
| 케이유엠두서 | 10 | 특수 품번 체계 | 수동 등록 필요 |
| 신규 전선 품목 | - | 매핑 미등록 | 매핑 추가 필요 |

---

## 분석 스크립트 (참고용)

작업 중 사용한 분석 스크립트들 (정리 완료):
- `analyze-barcode.cjs`: 바코드 패턴 분석
- `analyze-improved.cjs`: 개선된 매칭 로직 검증
- `analyze-unmatched.cjs`: 불일치 케이스 상세 분석
- `extract-wire-mapping.cjs`: 전선 색상코드 매핑 추출
